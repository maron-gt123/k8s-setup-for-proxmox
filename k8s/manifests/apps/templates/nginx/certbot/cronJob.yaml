apiVersion: batch/v1
kind: CronJob
metadata:
  name: certbot-ddnsnow
  namespace: certbot
spec:
  schedule: "0 0 */30 * *"  # 30日に1回
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsUser: 0
          volumes:
            - name: certs
              persistentVolumeClaim:
                claimName: certbot-pvc
            - name: ddns-secret
              secret:
                secretName: ddns-now-secret
          containers:
            - name: certbot
              image: certbot/certbot:latest
              volumeMounts:
                - name: certs
                  mountPath: /etc/letsencrypt
                - name: ddns-secret
                  mountPath: /etc/secrets
                  readOnly: true
              env:
                - name: DOMAIN
                  valueFrom:
                    secretKeyRef:
                      name: ddns-now-secret
                      key: DOMAIN
                - name: EMAIL
                  valueFrom:
                    secretKeyRef:
                      name: ddns-now-secret
                      key: EMAIL
                - name: USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: ddns-now-secret
                      key: USERNAME
                - name: API_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: ddns-now-secret
                      key: API_TOKEN
              command:
                - /bin/sh
                - -c
                - |
                  mkdir -p /root/.ddnsnow
                  # 1. 公式スクリプトを取得
                  wget -O /root/.ddnsnow/DDNSNowAcmeSetup.sh "https://ddns.kuku.lu/files/DDNSNowAcmeSetup.txt"
                  chmod +x /root/.ddnsnow/DDNSNowAcmeSetup.sh

                  # 2. DDNSNowAcmeSetup.sh 実行（AuthHook生成）
                  sh /root/.ddnsnow/DDNSNowAcmeSetup.sh "${DOMAIN}" "${API_TOKEN}"
                  chmod +x /root/.ddnsnow/DDNSNowAcmeAuthHook.sh
                  # 3. 生成された AuthHook の存在確認
                  ls -l /root/.ddnsnow/DDNSNowAcmeAuthHook.sh
                  # 4. Certbot 実行
                  certbot certonly \
                    --server https://acme-v02.api.letsencrypt.org/directory \
                    --manual \
                    --preferred-challenges dns \
                    --manual-auth-hook ~/.ddnsnow/DDNSNowAcmeAuthHook.sh \
                    -d "${DOMAIN}" \
                    --agree-tos \
                    -m "${EMAIL}" \
                    --keep-until-expiring

                  # 4. nginx 再読込
                  pkill -HUP nginx || true
